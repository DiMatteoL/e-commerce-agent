# Architecture Diagram - OAuth Reconnection Flow

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Connection Banner   â”‚  â”‚ Status Indicator â”‚  â”‚  GA4 Onboarding     â”‚   â”‚
â”‚  â”‚ (Top of Page)       â”‚  â”‚ (Sidebar/Header) â”‚  â”‚  Dialog             â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚                  â”‚  â”‚                      â”‚   â”‚
â”‚  â”‚ [!] Expired         â”‚  â”‚  ğŸŸ¢ Connected    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ [Reconnect Button]  â”‚  â”‚  ğŸ”´ Expired      â”‚  â”‚  â”‚ Select Propertyâ”‚ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  ğŸŸ¡ Expiring     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  [Reconnect Error] â”‚   â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          CHAT INTERFACE                                â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  User: "Show me top products by revenue"                             â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  Assistant: "I encountered an issue accessing your Google            â”‚ â”‚
â”‚  â”‚  Analytics data. Your connection has expired..."                     â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ [!] Google Analytics Connection Required                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Your connection has expired. Click to reconnect.               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ [Reconnect Google Account]                                     â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ tRPC API Calls
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              tRPC API LAYER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  google_analytics.getConnectionStatus()                                      â”‚
â”‚  â”œâ”€â–º Returns: { status, isHealthy, needsReconnection, warningMessage }      â”‚
â”‚  â””â”€â–º Used by: Banner, Indicator, Settings                                   â”‚
â”‚                                                                               â”‚
â”‚  google_analytics.testConnection()                                           â”‚
â”‚  â”œâ”€â–º Makes lightweight API call to verify credentials                        â”‚
â”‚  â””â”€â–º Used by: Settings panel, Debug                                          â”‚
â”‚                                                                               â”‚
â”‚  google_analytics.verifyReconnection()                                       â”‚
â”‚  â”œâ”€â–º Called after OAuth flow completes                                       â”‚
â”‚  â””â”€â–º Reconciles accounts, checks property                                    â”‚
â”‚                                                                               â”‚
â”‚  google_analytics.listAccounts()                                             â”‚
â”‚  â”œâ”€â–º Enhanced error handling for OAuth errors                                â”‚
â”‚  â””â”€â–º Throws structured errors with reconnect URLs                            â”‚
â”‚                                                                               â”‚
â”‚  google_analytics.disconnectGoogle()                                         â”‚
â”‚  â””â”€â–º Allows user to manually disconnect                                      â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Internal Function Calls
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GOOGLE OAUTH CLIENT LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  getGoogleOAuthClientForUser(userId)                                         â”‚
â”‚  â”œâ”€â–º 1. Fetch account from DB                                                â”‚
â”‚  â”œâ”€â–º 2. Check scopes                                                         â”‚
â”‚  â”œâ”€â–º 3. Check token expiration                                               â”‚
â”‚  â”œâ”€â–º 4. Refresh if needed (with retry)                                       â”‚
â”‚  â””â”€â–º 5. Return configured OAuth2Client OR throw GoogleOAuthRequired         â”‚
â”‚                                                                               â”‚
â”‚  Error Classification:                                                        â”‚
â”‚  â”œâ”€â–º NO_ACCOUNT: User never connected                                        â”‚
â”‚  â”œâ”€â–º MISSING_SCOPES: Old connection without Analytics                        â”‚
â”‚  â”œâ”€â–º TOKEN_EXPIRED: No refresh token available                               â”‚
â”‚  â”œâ”€â–º TOKEN_REVOKED: Refresh returned invalid_grant                           â”‚
â”‚  â””â”€â–º REFRESH_FAILED: Other refresh errors                                    â”‚
â”‚                                                                               â”‚
â”‚  checkGoogleConnectionHealth(userId)                                         â”‚
â”‚  â”œâ”€â–º Checks account status WITHOUT making API calls                          â”‚
â”‚  â””â”€â–º Returns: { status, isHealthy, needsReconnection, ... }                 â”‚
â”‚                                                                               â”‚
â”‚  reconcileGoogleAccount(userId)                                              â”‚
â”‚  â”œâ”€â–º Handles duplicate accounts (edge case)                                  â”‚
â”‚  â””â”€â–º Ensures user has exactly one Google account                             â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Database Operations
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATABASE LAYER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  accounts table:                                                              â”‚
â”‚  â”œâ”€ userId                 (FK to users)                                     â”‚
â”‚  â”œâ”€ provider               ("google")                                        â”‚
â”‚  â”œâ”€ providerAccountId      (Google's user ID)                                â”‚
â”‚  â”œâ”€ access_token           (Short-lived, ~1 hour)                            â”‚
â”‚  â”œâ”€ refresh_token          (Long-lived, used to get new access tokens)       â”‚
â”‚  â”œâ”€ expires_at             (Unix timestamp)                                  â”‚
â”‚  â”œâ”€ scope                  (Space-separated list)                            â”‚
â”‚  â”œâ”€ id_token               (JWT with user info)                              â”‚
â”‚  â””â”€ (Optional tracking fields added by Spec 02)                              â”‚
â”‚                                                                               â”‚
â”‚  googleAnalyticsProperties table:                                            â”‚
â”‚  â”œâ”€ userId                 (Which user selected this)                        â”‚
â”‚  â”œâ”€ propertyResourceName   (e.g., "properties/123456")                       â”‚
â”‚  â”œâ”€ selected               (Boolean, one per user)                           â”‚
â”‚  â””â”€ PRESERVED during reconnection âœ“                                          â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ OAuth Flow
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NEXTAUTH INTEGRATION                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Enhanced signIn Callback:                                                   â”‚
â”‚  â”œâ”€â–º 1. Check if account already exists                                      â”‚
â”‚  â”œâ”€â–º 2. If exists: UPDATE tokens (not create new)                            â”‚
â”‚  â”œâ”€â–º 3. If new: Let adapter create account                                   â”‚
â”‚  â””â”€â–º 4. Return true (allow sign-in)                                          â”‚
â”‚                                                                               â”‚
â”‚  GoogleProvider Configuration:                                               â”‚
â”‚  â”œâ”€â–º access_type: "offline" (to get refresh_token)                           â”‚
â”‚  â”œâ”€â–º prompt: "consent" (always request fresh tokens)                         â”‚
â”‚  â”œâ”€â–º scope: [..., "analytics.readonly"]                                      â”‚
â”‚  â””â”€â–º allowDangerousEmailAccountLinking: true                                 â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Reconnection Flow Sequence

```
â”Œâ”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚                â”‚ Browser â”‚              â”‚  Server  â”‚         â”‚  Google  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Sees "Reconnect" banner â”‚                        â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Clicks [Reconnect]      â”‚                        â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ GET /api/auth/signin   â”‚                    â”‚
   â”‚                         â”‚    ?provider=google    â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ Redirect to Google     â”‚                    â”‚
   â”‚                         â”‚ OAuth consent screen   â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Reviews permissions     â”‚                        â”‚                    â”‚
   â”‚ Clicks "Allow"          â”‚                        â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                  Callback with code         â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   Exchange code for tokens  â”‚
   â”‚                         â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   â—„â”€â”€â”€â”€â”¤ Return tokens      â”‚
   â”‚                         â”‚                        â”‚ (access + refresh) â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚              signIn callback invoked        â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ Check if account   â”‚
   â”‚                         â”‚                   â”‚   â”‚ exists for this    â”‚
   â”‚                         â”‚                   â”‚   â”‚ providerAccountId  â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ UPDATE existing     â”‚
   â”‚                         â”‚                   â”‚   â”‚ account with new   â”‚
   â”‚                         â”‚                   â”‚   â”‚ tokens (not create)â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ Redirect to app        â”‚                    â”‚
   â”‚                         â”‚ with session cookie    â”‚                    â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ verifyReconnection()   â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ Reconcile accounts â”‚
   â”‚                         â”‚                   â”‚   â”‚ Check health       â”‚
   â”‚                         â”‚                   â”‚   â”‚ Verify property    â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ { success: true }      â”‚                    â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Banner disappears       â”‚                        â”‚                    â”‚
   â”‚ Indicator turns green   â”‚                        â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ "Show top products"     â”‚                        â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (Chat message)         â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ GA4 tool executes  â”‚
   â”‚                         â”‚                   â”‚   â”‚ âœ“ Tokens valid     â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                        â”‚ Analytics API call â”‚
   â”‚                         â”‚                   â—„â”€â”€â”€â”€â”¤ Success!           â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ Stream response        â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ with data             â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
```

## Error Flow - Token Expired

```
â”Œâ”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚                â”‚ Browser â”‚              â”‚  Server  â”‚         â”‚  Google  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ "Show top products"     â”‚                        â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (Chat message)         â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   runGaReport()             â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ getOAuthClient()   â”‚
   â”‚                         â”‚                   â”‚   â”‚ â”œâ”€â–º Check DB       â”‚
   â”‚                         â”‚                   â”‚   â”‚ â”œâ”€â–º Token expired  â”‚
   â”‚                         â”‚                   â”‚   â”‚ â”œâ”€â–º Try refresh    â”‚
   â”‚                         â”‚                   â”‚   â”‚ â””â”€â–º Refresh fails! â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   throw GoogleOAuthRequired â”‚
   â”‚                         â”‚                   (TOKEN_REVOKED)           â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   Caught in chunk-loop      â”‚
   â”‚                         â”‚                   â”œâ”€â”€â”€â”                     â”‚
   â”‚                         â”‚                   â”‚   â”‚ Detect OAuth error â”‚
   â”‚                         â”‚                   â”‚   â”‚ Format user msg    â”‚
   â”‚                         â”‚                   â”‚â—„â”€â”€â”˜                     â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ Tool error message     â”‚                    â”‚
   â”‚                         â”‚ (OAUTH_REQUIRED)       â”‚                    â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚                   AI receives error         â”‚
   â”‚                         â”‚                   Responds with explanation â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚                         â”‚ Stream AI response     â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ + OAuth error componentâ”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Sees friendly message   â”‚                        â”‚                    â”‚
   â”‚ + [Reconnect] button    â”‚                        â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ (Parallel) Status check â”‚                        â”‚                    â”‚
   â”‚                         â”‚ getConnectionStatus()  â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                         â”‚ { needsReconnection: true }                 â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
   â”‚ Banner appears at top   â”‚                        â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚                    â”‚
   â”‚                         â”‚                        â”‚                    â”‚
```

## Token Refresh Flow (Automatic)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server  â”‚              â”‚    DB    â”‚         â”‚  Google  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                         â”‚                    â”‚
     â”‚ getOAuthClient()        â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                         â”‚                    â”‚
     â”‚ SELECT * FROM accounts  â”‚                    â”‚
     â”‚ WHERE userId = ?        â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                         â”‚                    â”‚
     â”œâ”€â”€â”€â”                     â”‚                    â”‚
     â”‚   â”‚ Check expiration    â”‚                    â”‚
     â”‚   â”‚ expires_at < now    â”‚                    â”‚
     â”‚â—„â”€â”€â”˜ + 60s buffer        â”‚                    â”‚
     â”‚                         â”‚                    â”‚
     â”œâ”€â”€â”€â”                     â”‚                    â”‚
     â”‚   â”‚ Needs refresh!      â”‚                    â”‚
     â”‚â—„â”€â”€â”˜                     â”‚                    â”‚
     â”‚                         â”‚                    â”‚
     â”‚ refreshAccessToken()    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                         â”‚                    â”‚
     â”‚                         â”‚   POST /token      â”‚
     â”‚                         â”‚   grant_type=      â”‚
     â”‚                         â”‚   refresh_token    â”‚
     â”‚                         â”‚                    â”‚
     â”‚                    â—„â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ New access_token        â”‚                    â”‚
     â”‚ New expires_at          â”‚                    â”‚
     â”‚ (Maybe new refresh_token)                    â”‚
     â”‚                         â”‚                    â”‚
     â”‚ UPDATE accounts         â”‚                    â”‚
     â”‚ SET access_token = ?    â”‚                    â”‚
     â”‚     refresh_token = ?   â”‚                    â”‚
     â”‚     expires_at = ?      â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                         â”‚                    â”‚
     â”‚                    â—„â”€â”€â”€â”€â”¤                    â”‚
     â”‚ Success                 â”‚                    â”‚
     â”‚                         â”‚                    â”‚
     â”œâ”€â”€â”€â”                     â”‚                    â”‚
     â”‚   â”‚ Return OAuth2Client â”‚                    â”‚
     â”‚   â”‚ with fresh tokens   â”‚                    â”‚
     â”‚â—„â”€â”€â”˜                     â”‚                    â”‚
     â”‚                         â”‚                    â”‚
```

## Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPLICATION LAYOUT                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GoogleConnectionBanner                                        â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ useGoogleConnectionStatus()                              â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â”œâ”€â–º Polls: getConnectionStatus every 5 min              â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€â–º Shows banner if needsReconnection                    â”‚ â”‚ â”‚
â”‚  â”‚ â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ useReconnectGoogle()                                     â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€â–º Handles: startReconnection() â†’ OAuth flow           â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AppSidebar     â”‚  â”‚ Main Content Area                         â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚Connection  â”‚ â”‚  â”‚ â”‚ Chat                                  â”‚ â”‚ â”‚
â”‚  â”‚ â”‚Indicator   â”‚ â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚ â”‚            â”‚ â”‚  â”‚ â”‚ â”‚ ChatErrorBoundary                 â”‚ â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ ğŸŸ¢ Status  â”‚ â”‚  â”‚ â”‚ â”‚ â”œâ”€â–º Catches OAuth errors          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚ â”‚            â”‚ â”‚  â”‚ â”‚ â”‚ â””â”€â–º Shows recovery UI             â”‚ â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ [Click to  â”‚ â”‚  â”‚ â”‚ â”‚                                   â”‚ â”‚ â”‚ â”‚
â”‚  â”‚ â”‚  reconnect]â”‚ â”‚  â”‚ â”‚ â”‚ ChatMessage (with OAuth detection)â”‚ â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚ â”‚ â”œâ”€â–º extractOAuthError()           â”‚ â”‚ â”‚ â”‚
â”‚  â”‚                â”‚  â”‚ â”‚ â”‚ â””â”€â–º Renders ChatOAuthError if foundâ”‚ â”‚ â”‚ â”‚
â”‚  â”‚ NavMain        â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚ NavProjects    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ NavUser        â”‚  â”‚                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - Connection Status

```
Frontend Component
       â”‚
       â”‚ calls
       â–¼
useGoogleConnectionStatus()
       â”‚
       â”‚ queries (cached, 5min refetch)
       â–¼
tRPC: google_analytics.getConnectionStatus
       â”‚
       â”‚ calls
       â–¼
checkGoogleConnectionHealth(userId)
       â”‚
       â”‚ SELECT FROM accounts WHERE...
       â–¼
Database
       â”‚
       â”‚ returns account data
       â–¼
Health Check Logic:
â”œâ”€â–º No account? â†’ "not_connected"
â”œâ”€â–º Missing scopes? â†’ "missing_scopes"
â”œâ”€â–º Token expired & no refresh? â†’ "expired"
â”œâ”€â–º Token expiring in < 7 days? â†’ "expiring_soon"
â””â”€â–º Otherwise â†’ "connected"
       â”‚
       â”‚ returns
       â–¼
{
  status: "expired",
  isHealthy: false,
  needsReconnection: true,
  warningMessage: "Your Google connection has expired",
  errorReason: "TOKEN_EXPIRED"
}
       â”‚
       â”‚ updates state
       â–¼
Component renders appropriate UI
```

## Legend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Box    â”‚  Component or system boundary
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  Data flow or function call

â”œâ”€â”€â”€â”
â”‚   â”‚       Internal logic/decision
â”‚â—„â”€â”€â”˜

[Button]    User interaction element

ğŸŸ¢ ğŸ”´ ğŸŸ¡     Status indicators (healthy, error, warning)

// Comment   Code comment or explanation
```

This architecture ensures:
- âœ… Clear separation of concerns
- âœ… Reusable components
- âœ… Type-safe error handling
- âœ… Minimal database queries (cached status)
- âœ… User-friendly experience
- âœ… No data loss during reconnection
